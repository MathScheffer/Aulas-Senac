/*
• Faça um procedimento, considerando o modelo de cliente,
pedido, produto e movimento, de forma que:
– A) não permita excluir um produto o qual já tenha sido pedido;
– B) ao tentar inserir inserir um novo produto, que o seu nome tenha
valor;
– Atenção: defina a qtd de parametros necessários para tratar estas
duas regras acima citadas.*/


DROP FUNCTION FN_MOVIMENTAR(int, int, char, double precision, char);

CREATE OR REPLACE FUNCTION FN_MOVIMENTAR(chave int, _cod_prod int, _nome char(30),
										 _preco double precision, _categoria char(30))
RETURNS VOID AS
$$
BEGIN
	IF chave = 0 THEN	
		IF(SELECT  fn_verifica_prod_NAO_pedido(_cod_prod)) THEN
			DELETE FROM produto WHERE produto.cod_prod = _cod_prod;
		ELSE
			RAISE EXCEPTION 'Produto foi pedido';
		END IF;
	ELSIF chave = 1 THEN
		IF (NOT fn_verifica_produto_existe(_cod_prod)) THEN
			INSERT INTO produto(cod_prod,nome, preco, categoria) 
				VALUES(_cod_prod,_nome,_preco,_categoria);
		ELSE 
			RAISE EXCEPTION 'O código inserido já existe';
		END IF;
	ELSE 
		RAISE EXCEPTION 'Insira somente 0 para deletar ou 1 para inserir';
	END IF;
END;
$$ LANGUAGE PLPGSQL



BEGIN TRANSACTION
	INSERT INTO produto(cod_prod,nome, preco, categoria) VALUES(7,'teste',20.0,'teste')
	select FN_MOVIMENTAR(0, 1, 'teste',0.0, 'teste') -- Retorna exceção de produto já pedido
	select FN_MOVIMENTAR(1, 1, 'teste',0.0, 'teste') -- Não insere pois já existe pedido com este cod
	select FN_MOVIMENTAR(0, 7, 'teste',0.0, 'teste') -- Deleta pedido
	select fn_movimentar(1,7,'Notebook dell',4500.5,'informatica') -- Insere pedido
rollback;

select * from produto;


DROP FUNCTION fn_verifica_prod_NAO_pedido(int)
CREATE OR REPLACE FUNCTION fn_verifica_prod_NAO_pedido(codProd int) RETURNS BOOLEAN AS
$$
BEGIN
	PERFORM * FROM movimento WHERE cod_prod = codProd;
	IF FOUND THEN
		RETURN FALSE;
	ELSE 
		return TRUE;
	END IF;
END;
$$
LANGUAGE PLPGSQL;
SELECT  fn_verifica_prod_NAO_pedido(2);

CREATE OR REPLACE FUNCTION fn_verifica_produto_existe(_cod_produto int) RETURNS BOOLEAN AS
$$
BEGIN
	PERFORM * FROM produto WHERE cod_prod = _cod_produto;
	IF FOUND THEN
		RETURN TRUE;
	ELSE
		RETURN FALSE;
	END IF;
END;
$$
LANGUAGE PLPGSQL;

SELECT fn_verifica_produto_existe(8) 



